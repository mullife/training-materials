\setbeamerfont{block title}{size=\scriptsize}

\section{Autoconf advanced}

\subsection{Configuration header}

\begin{frame}[fragile]{Configuration header}
  \begin{itemize}
  \item Very often, C/C++ code needs to know the result of certain
    tests done by the \code{configure} script.
  \item A template C header file can be automatically generated by
    \code{autoheader}, generally named \code{config.h.in}
  \item The final header file is generated by \code{configure},
    generally named \code{config.h}
  \item Declared using \code{AC_CONFIG_HEADERS}
    \begin{block}{\code{configure.ac} extract}
\begin{minted}[fontsize=\scriptsize]{bash}
AC_CONFIG_HEADERS([config.h])
\end{minted}
    \end{block}

    \begin{block}{Example config.h}
\begin{minted}[fontsize=\scriptsize]{c}
/* Define if the complete vga libraries (vga, vgagl) are installed */
/* #undef HAVE_LIBVGA */

/* Define to 1 if you have the <limits.h> header file. */
#define HAVE_LIMITS_H 1
\end{minted}
\end{block}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt AC\_DEFINE}}

  \begin{itemize}
  \item \code{AC_DEFINE} allows to create C definitions in the {\em
      configuration header}
  \item \code{AC_DEFINE (variable, value, description)}
  \end{itemize}

  \begin{block}{\code{configure.ac}}
\begin{minted}{bash}
AC_DEFINE([FOOBAR], [42], [This is the foobar value])
\end{minted}
  \end{block}

  \begin{block}{Generated \code{config.h}}
\begin{minted}{c}
/* This is the foobar value */
#define FOOBAR 42
\end{minted}
\end{block}

\end{frame}

\subsection{Checking for functions, headers, libraries, etc.}

\begin{frame}{Checking for functions}
  \begin{itemize}
  \item You may need to check if certain functions are available
    and/or meet certain characteristics
  \item Family of \code{AC_FUNC_*} macros
    \begin{itemize}
    \item \code{AC_FUNC_FORK}, \code{AC_FUNC_GETLOADAVG}, \code{AC_FUNC_MALLOC}, etc.
    \item See {\em autoconf} manual for details
    \end{itemize}
  \item \code{AC_CHECK_FUNC[S]} to check for generic functions
    \begin{itemize}
    \item \code{AC_CHECK_FUNC (function, [action-if-found],
        [action-if-not-found])}
    \item \code{AC_CHECK_FUNCS (function..., [action-if-found],
        [action-if-not-found])}
    \item Results available
      \begin{itemize}
      \item \code{ac_cv_func_<function>} variable in
        \code{configure.ac}
      \item \code{HAVE_<FUNCTION>} defines in {\em configuration
          headers}
      \end{itemize}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt AC\_CHECK\_FUNCS()} example}

\begin{block}{configure.ac}
\begin{minted}[fontsize=\tiny]{bash}
AC_CHECK_FUNCS([printf foobar])
echo "ac_cv_func_printf: ${ac_cv_func_printf}"
echo "ac_cv_func_foobar: ${ac_cv_func_foobar}"
AC_CONFIG_HEADER([config.h])
\end{minted}
\end{block}

\begin{block}{Execution of \code{./configure}}
\begin{minted}[fontsize=\tiny]{console}
$ ./configure
[...]
checking for printf... yes
checking for foobar... no
ac_cv_func_printf: yes
ac_cv_func_foobar: no
[...]
config.status: creating config.h
\end{minted}
\end{block}

\begin{block}{Generated \code{config.h}}
\begin{minted}[fontsize=\tiny]{c}
[...]
/* Define to 1 if you have the `foobar' function. */
/* #undef HAVE_FOOBAR */

/* Define to 1 if you have the `printf' function. */
#define HAVE_PRINTF 1
[...]
\end{minted}
\end{block}

\end{frame}

\begin{frame}{Checking for headers}

  \begin{itemize}
  \item Much like \code{AC_FUNC_*} and \code{AC_CHECK_FUNC[S]}, but for headers
  \item Variety of \code{AC_HEADER_*} macros
    \begin{itemize}
    \item Check the autoconf manual for details
    \end{itemize}
  \item \code{AC_CHECK_HEADER[S]} for generic headers checking
    \begin{itemize}
    \item \code{AC_CHECK_HEADER (header-file, [action-if-found], [action-if-not-found], [includes])}
    \item \code{AC_CHECK_HEADERS (header-file..., [action-if-found], [action-if-not-found], [includes])}
    \item Results available in:
      \begin{itemize}
      \item \code{ac_cv_header_<header-file>} variable in
        \code{configure.ac}
      \item \code{HAVE_<HEADER>_H} define in \code{config.h}
      \end{itemize}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt AC\_CHECK\_HEADERS} example}

\begin{block}{\code{configure.ac}}
\begin{minted}[fontsize=\scriptsize]{bash}
[...]
AC_CHECK_HEADERS([spawn.h],
        [echo "Header spawn.h was found"; has_spawn=yes],
        [echo "Header spawn.h was not found"])
echo ${has_spawn}
[...]
\end{minted}
\end{block}

\begin{block}{Execution of \code{./configure}}
\begin{minted}[fontsize=\scriptsize]{console}
$ ./configure
[...]
checking for spawn.h... yes
Header spawn.h was found
yes
[...]
\end{minted}
\end{block}

\end{frame}

\begin{frame}[fragile]{Checking for libraries}
  \begin{block}{}
\begin{minted}[fontsize=\small]{bash}
AC_SEARCH_LIBS (function, search-libs,
                [action-if-found], [action-if-not-found],
                [other-libraries])
\end{minted}
  \end{block}

  \begin{itemize}
  \item Search for a library defining \code{function}, by linking a
    simple program calling \code{function}
  \item Tries first with no library, and then with the different
    libraries in \code{search-libs}, one after the other.
  \item If a library is found, \code{-llibrary} is prepended to the
    \code{LIBS} variable, so programs will be linked against
    it. \code{action-if-found} is executed.
  \item If not, \code{action-if-not-found} is executed
  \item \code{other-libraries} allows to pass additional
    \code{-l<foo>} arguments that may be needed for the link test to
    succeed.
  \item Result in \code{ac_cv_search_<function>}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt AC\_SEARCH\_LIBS} example}

\begin{block}{\code{configure.ac}}
\begin{minted}[fontsize=\small]{bash}
AC_SEARCH_LIBS(mvwaddstr, [ncurses cursesX curses])
\end{minted}
\end{block}

\begin{block}{Execution of \code{./configure}}
\begin{minted}[fontsize=\small]{console}
$ ./configure
[...]
checking for library containing mvwaddstr... -lncurses
[...]
$ grep ac_cv_search_mvwaddstr config.log
ac_cv_search_mvwaddstr=-lncurses
\end{minted}
\end{block}

\begin{block}{Compilation}
\begin{minted}[fontsize=\small]{console}
$ make
[...]
gcc  -g -O2   -o hello main.o common.o  -lncurses
[...]
gcc  -g -O2   -o test test.o common.o  -lncurses
\end{minted}
\end{block}

\end{frame}

\begin{frame}{Other checks}
  \begin{itemize}
  \item {\bf Programs} with \code{AC_CHECK_PROGS}
    \begin{itemize}
    \item \code{AC_CHECK_PROGS(PERL, [perl5 perl])}
    \end{itemize}
  \item {\bf Declarations} with \code{AC_CHECK_DECLS}
  \item {\bf Structure members} with \code{AC_CHECK_MEMBERS}
  \item {\bf Types} with \code{AC_CHECK_TYPES}
    \begin{itemize}
    \item \code{AC_CHECK_TYPES(int8_t)}
    \end{itemize}
  \item See the {\em autoconf} manual for details
  \end{itemize}
\end{frame}

\subsection{Custom tests}

\begin{frame}{Writing new tests}
  \begin{itemize}
  \item You can create your own tests by pre-processing, compiling or
    linking small test programs:
    \begin{itemize}
    \item Pre-processing test\\
      {\small \code{AC_PREPROC_IFELSE (input, [action-if-true], [action-if-false])}}
    \item Compiling test\\
      {\small \code{AC_COMPILE_IFELSE (input, [action-if-true], [action-if-false])}}
    \item Link test\\
      {\small \code{AC_LINK_IFELSE (input, [action-if-true], [action-if-false])}}
    \end{itemize}
  \item Input should be formatted with \code{AC_LANG_SOURCE} or
    \code{AC_LANG_PROGRAM}
  \item Runtime tests can also be created
    \begin{itemize}
    \item Beware, by nature, they cannot work for cross-compilation!
    \item \code{AC_RUN_IFELSE}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Writing new tests: {\tt AC\_LINK\_IFELSE}}

\begin{block}{\code{configure.ac}}
\begin{minted}[fontsize=\small]{bash}
AC_LINK_IFELSE([AC_LANG_PROGRAM([#include <langinfo.h>],
        [char *codeset = nl_langinfo (CODESET);])],
    [glib_cv_langinfo_codeset=yes],
    [glib_cv_langinfo_codeset=no])
\end{minted}
\end{block}

\begin{block}{Variable in \code{config.log}}
\begin{minted}{console}
$ grep glib_cv_langinfo_codeset config.log
glib_cv_langinfo_codeset=yes
\end{minted}
\end{block}

\end{frame}

\begin{frame}{Printing messages}
  \begin{itemize}
  \item When creating new tests, you may want to show messages,
    warnings, errors, etc.
  \item \code{AC_MSG_CHECKING (feature-description)}
    \begin{itemize}
    \item Notify the user that configure is checking for a
      particular feature.
    \end{itemize}
  \item \code{AC_MSG_RESULT (result-description)}
    \begin{itemize}
    \item Notify the user of the results of a check
    \end{itemize}
  \item \code{AC_MSG_NOTICE (message)}
    \begin{itemize}
    \item Deliver the {\em message} to the user.
    \end{itemize}
  \item \code{AC_MSG_ERROR (error-description, [exit-status = ‘$?/1’])}
    \begin{itemize}
    \item Notify the user of an error that prevents configure from
      completing.
    \end{itemize}
  \item \code{AC_MSG_WARN (problem-description)}
    \begin{itemize}
    \item Notify the configure user of a possible problem.
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Printing messages: example}

\begin{block}{\code{configure.ac}}
\begin{minted}[fontsize=\small]{bash}
AC_MSG_CHECKING([for nl_langinfo])
AC_LINK_IFELSE([AC_LANG_PROGRAM([#include <langinfo.h>],
            [char *codeset = nl_langinfo (CODESET);])],
       [glib_cv_langinfo_codeset=yes],
       [glib_cv_langinfo_codeset=no])
AC_MSG_RESULT([$glib_cv_langinfo_codeset])
\end{minted}
\end{block}

\begin{block}{Execution of \code{./configure}}
\begin{minted}{console}
$ ./configure
[...]
checking for nl_langinfo... yes
[...]
\end{minted}
\end{block}

\end{frame}

\subsection{External software and optional features}

\begin{frame}[fragile]{Using external software}
  \begin{itemize}
  \item When a package uses external software,
    \code{--with-<package>=<arg>} and \code{--without-<package>}
    options are generally offered to control usage of the external
    software.
  \item Implemented using the \code{AC_ARG_WITH} macro.
    \begin{block}{}
\begin{minted}[fontsize=\small]{bash}
AC_ARG_WITH (package, help-string,
             [action-if-given], [action-if-not-given])
\end{minted}
    \end{block}
    \begin{itemize}
    \item \code{package} gives the name of the option
    \item \code{help-string} is the help text, visible in
      \code{./configure --help}
    \item \code{action-if-given} is executed when the option is used,
      either positively (\code{--with}) or negatively (\code{--without})
    \item \code{action-if-not-given} is executed when the option is not
      used
    \item \code{<arg>} available as \code{$withval} inside {\em
        action-if-given}, \code{$with_<package>} outside.
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Package options}

  \begin{itemize}

  \item When a package offers optional features,
    \code{--enable-<feature>} and \code{--disable-<feature>} options
    are generally offered to control the optional feature.
  \item Implemented using the \code{AC_ARG_ENABLE} macro.
\begin{block}{}
\begin{minted}[fontsize=\small]{bash}
AC_ARG_ENABLE (feature, help-string,
               [action-if-given], [action-if-not-given])
\end{minted}
\end{block}
\item Usage very similar to the one of \code{AC_ARG_WITH}
\item Value available as \code{$enableval} inside {\em
    action-if-given}, \code{$enable_<feature>} outside.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{Formatting the help string}
  \begin{itemize}
  \item To help formatting the help string, {\em autoconf} provides
    the \code{AS_HELP_STRING} macro
  \item Allows to properly align the different options in the
    \code{./configure --help} output
\begin{block}{}
\begin{minted}[fontsize=\small]{bash}
AS_HELP_STRING (left-hand-side, right-hand-side,
      [indent-column = '26'], [wrap-column = '79'])
\end{minted}
\end{block}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt AC\_ARG\_ENABLE} example}

\begin{block}{configure.ac}
\begin{minted}[fontsize=\scriptsize]{bash}
AC_ARG_ENABLE([test], AS_HELP_STRING([--enable-test], [Enable tests]),
      [echo "Action if given, val = ${enableval}"],
      [echo "Action if not given"])
echo "enable_test = ${enable_test}"
\end{minted}
\end{block}

\begin{block}{\code{./configure} tests}
\begin{minted}[fontsize=\tiny]{console}
$ ./configure --help
[...]
Optional Features:
[...]
  --enable-test           Enable tests
$ ./configure
[...]
Action if not given
enable_test = 
[...]
$ ./configure --enable-test
[...]
Action if given, val = yes
enable_test = yes
[...]
$ ./configure --disable-test
[...]
Action if given, val = no
enable_test = no
[...]
\end{minted}
\end{block}

\end{frame}

\subsection{pkg-config}

\begin{frame}{Using pkg-config with {\tt autoconf}}

  \begin{itemize}

  \item To find libraries, a much better solution than
    \code{AC_SEARCH_LIBS} is to use {\bf pkg-config}

  \item pkg-config is a database of small text files, using the
    \code{.pc} extension, describing how to use a given library
    \begin{itemize}
    \item installed in \code{usr/lib/pkgconfig} on most systems
    \item installed by most modern libraries
    \end{itemize}

  \item The \code{pkg-config} command line tool allows to query this
    database for the compiler and linker flags needed to use a given
    library.

  \item The \code{PKG_CHECK_MODULES} {\em autoconf} macro allows to
    query the pkg-config database.

  \end{itemize}

\end{frame}

\begin{frame}[fragile]{The {\tt PKG\_CHECK\_MODULES} macro}
\begin{itemize}
\item Syntax:
  \begin{block}{}
\begin{minted}[fontsize=\small]{bash}
PKG_CHECK_MODULES(prefix, list-of-modules,
                  action-if-found, action-if-not-found)
\end{minted}
  \end{block}
\item \code{prefix} will be used to create the
  \code{<prefix>_CFLAGS} and \code{<prefix>_LIBS} variables
  \begin{itemize}
  \item Contain the pre-processor and linker flags to use the
    libraries listed in \code{list-of-modules}
  \item Are already \code{AC_SUBST}ed, so can be used directly in
    \code{Makefile.am}
  \end{itemize}
\item \code{list-of-modules} is one or several pkg-config libraries
  \begin{itemize}
  \item Can contain version specifiers, such as \code{foo >= 3 bar
      baz <= 4}
  \end{itemize}
\item Will exit with a failure if one of the dependencies is missing.
\end{itemize}
\end{frame}

\begin{frame}[fragile]{{\tt PKG\_CHECK\_MODULES} example}

\begin{block}{configure.ac}
\begin{minted}[fontsize=\tiny]{bash}
PKG_CHECK_MODULES(DBUS1,
     dbus-1 >= 1.2.14,
     [AC_DEFINE(HAVE_DBUS1, 1, [Define if dbus-1 is available]) have_dbus1=yes],
     have_dbus1=no)
\end{minted}
\end{block}

\begin{block}{Makefile.am}
\begin{minted}[fontsize=\tiny]{make}
gdbus_serialization_CFLAGS = $(AM_CFLAGS) $(DBUS1_CFLAGS)
gdbus_serialization_LDADD = $(LDADD) $(DBUS1_LIBS)
\end{minted}
\end{block}

\end{frame}

\subsection{Misc}

\begin{frame}{{\tt autoscan}}
  \begin{itemize}
  \item \code{autoscan} is a program provided together with \code{autoconf}
  \item Scans the source tree in the current directory (or the one
    passed as argument)
  \item From that, \code{autoscan}:
    \begin{itemize}
    \item Searches the source files for common portability problems
    \item Checks for incompleteness of the \code{configure.ac} file, if any
    \item Generates \code{configure.scan}, which can be used as a
      preliminary \code{configure.ac}
    \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Additional {\tt m4} macros}
  \begin{itemize}
  \item The core \code{autoconf} macros are installed in
    \code{/usr/share/autoconf/autoconf/}
  \item Additional macros can be installed by other packages in
    \code{/usr/share/aclocal}
    \begin{itemize}
    \item Examples: \code{pkg.m4} (for pkg-config),
      \code{gpg-error.m4}, \code{iconv.m4}, etc.
    \end{itemize}
  \item The {\bf GNU Autoconf Archive} is a collection of more than
    500 macros for \code{autoconf}
    \begin{itemize}
    \item \url{http://www.gnu.org/software/autoconf-archive/}
    \item Example:
      \code{AX_C_LONG_LONG}, {\em Provides a test for the existence of the long long int type and defines HAVE\_LONG\_LONG if it is found.}
    \end{itemize}
  \end{itemize}
\end{frame}

\section{Automake advanced}

\subsection{Subdirectories}

\begin{frame}{Subdirectories}
  \begin{itemize}
  \item A project is often organized with multiple directories
  \item \code{automake} offers two options to support this:
    \begin{itemize}
    \item {\bf recursive make}, where a sub-call to \code{make} is made
      for sub-directories, and each directory has its own
      \code{Makefile.am}
    \item {\bf non-recursive make}, where there is a single
      \code{Makefile.am}, building everything
    \end{itemize}
  \item {\bf recursive make} used to be the norm, but has significant
    drawbacks
    \begin{itemize}
    \item {\em Recursive make considered harmful},
      \url{http://aegis.sourceforge.net/auug97.pdf}
    \end{itemize}
  \item {\bf non-recursive make} is more and more commonly used in
    modern projects
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Recursive make}

  \begin{itemize}
  \item The \code{SUBDIRS} variable in a \code{Makefile.am} indicates
    the sub-directories that contain other \code{Makefile.am}
  \end{itemize}

  \begin{block}{configure.ac}
\begin{minted}{bash}
AC_CONFIG_FILES([Makefile src/Makefile])
\end{minted}
  \end{block}

  \begin{block}{Makefile.am}
\begin{minted}{make}
SUBDIRS = src
\end{minted}
  \end{block}

  \begin{block}{src/Makefile.am}
\begin{minted}{make}
bin_PROGRAMS = hello
hello_SOURCES = main.c
\end{minted}
  \end{block}
\end{frame}

\begin{frame}[fragile]{Non-recursive make}

  \begin{itemize}
  \item The \code{AM_INIT_AUTOMAKE} macro accepts a
    \code{subdir-objects} argument
  \item If specified, allows a \code{Makefile.am} to reference code in
    another directory
  \end{itemize}

\begin{block}{configure.ac}
\begin{minted}{bash}
AM_INIT_AUTOMAKE([subdir-objects])
AC_CONFIG_FILES([Makefile])
\end{minted}
\end{block}

\begin{block}{Makefile.am}
\begin{minted}{make}
bin_PROGRAMS = hello
hello_SOURCES = src/main.c
\end{minted}
\end{block}

\end{frame}

\subsection{Conditionals}

\begin{frame}[fragile]{{\em automake} conditionals}

  \begin{itemize}
  \item In order to use a conditional in a \code{Makefile.am}, it must
    be defined in the \code{configure.ac} script.
  \item Done using the \code{AM_CONDITIONAL(conditional, condition)}
    macro
  \end{itemize}

  \begin{block}{configure.ac}
\begin{minted}{bash}
AM_CONDITIONAL([DEBUG], [test x$debug = xtrue])
\end{minted}
  \end{block}

  \begin{block}{Makefile.am}
\begin{minted}{make}
if DEBUG
...
else
...
endif
\end{minted}
  \end{block}

\end{frame}

\begin{frame}[fragile]{Usage of {\em automake} conditionals}

  \begin{columns}
    \column{0.3\textwidth}
    You cannot use conditionals inside a variable definition
    \begin{block}{Non-working example}
\begin{minted}[fontsize=\tiny]{make}
bin_PROGRAMS = \
      bar \
if DEBUG
      baz \
endif
      foobar
\end{minted}
\end{block}

    \column{0.3\textwidth}
    You should instead use an intermediate variable

    \begin{block}{Working example}
\begin{minted}[fontsize=\tiny]{make}
if DEBUG
DEBUG_PROGS = baz
endif

bin_PROGRAMS = \
      bar \
      $(DEBUG_PROGS) \
      foobar
\end{minted}
\end{block}

    \column{0.3\textwidth}
    Or the \code{+=} assigment sign

    \begin{block}{Working example}
\begin{minted}[fontsize=\tiny]{make}
bin_PROGRAMS = \
      bar \
      foobar

if DEBUG
bin_PROGRAMS += baz
endif
\end{minted}
\end{block}
\end{columns}
\end{frame}

\begin{frame}[fragile]{Conditional example}

\begin{block}{configure.ac}
\begin{minted}[fontsize=\tiny]{bash}
AM_CONDITIONAL(THREADS_POSIX, [test "$g_threads_impl" = "POSIX"])
AM_CONDITIONAL(THREADS_WIN32, [test "$g_threads_impl" = "WIN32"])
AM_CONDITIONAL(THREADS_NONE, [test "$g_threads_impl" = "NONE"])
\end{minted}
\end{block}

\begin{block}{Makefile.am}
\begin{minted}[fontsize=\tiny]{make}
libglib_2_0_la_SOURCES =        \
        $(deprecated_sources)   \
        glib_probes.d           \
        garray.c                \
[...]

if THREADS_WIN32
libglib_2_0_la_SOURCES += gthread-win32.c
else
if THREADS_POSIX
libglib_2_0_la_SOURCES += gthread-posix.c
endif
endif
\end{minted}
\end{block}

\end{frame}

\subsection{Shared libraries}

\begin{frame}{Building shared libraries}
  \begin{itemize}
  \item Building shared libraries is very different between Unix
    variants
  \item A specific tool, called \code{libtool}, was created to
    abstract away the differences between platforms.
  \item Concept called {\em libtool libraries}, using the \code{.la}
    suffix
  \item A libtool library can designate a static library, a shared
    library, or both.
    \begin{itemize}
    \item \code{--{enable,disable}-{static,shared}} to select
    \end{itemize}
  \item Libtool libraries declared using the \code{LTLIBRARIES}
    primary in a \code{Makefile.am}
  \item Typically used in conjunction with the \code{HEADERS} primary
    to install public headers.
  \item \code{configure.ac} must call the \code{LT_PREREQ} and
    \code{LT_INIT} macros
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Libtool library example}

\begin{block}{configure.ac}
\begin{minted}[fontsize=\small]{bash}
[...]
LT_PREREQ([2.4])
LT_INIT
[...]
\end{minted}
\end{block}

\begin{block}{Makefile.am}
\begin{minted}[fontsize=\small]{make}
bin_PROGRAMS = hello
hello_SOURCES = src/main.c

lib_LTLIBRARIES = libmyhello.la
libmyhello_la_SOURCES = lib/core.c
include_HEADERS = lib/myhello.h
\end{minted}
\end{block}

\end{frame}

\begin{frame}[fragile]{Libtool library example (2/2)}

\begin{block}{}
\begin{minted}[fontsize=\tiny]{console}
$ ./configure
[...]
checking whether stripping libraries is possible... yes
checking if libtool supports shared libraries... yes
checking whether to build shared libraries... yes
checking whether to build static libraries... yes
[...]
$ make
[...]
$ make DESTDIR=/tmp/test install
[...]
$ find /tmp/test
/tmp/test/
/tmp/test/usr
/tmp/test/usr/local
/tmp/test/usr/local/include
/tmp/test/usr/local/include/myhello.h
/tmp/test/usr/local/bin
/tmp/test/usr/local/bin/hello
/tmp/test/usr/local/lib
/tmp/test/usr/local/lib/libmyhello.a
/tmp/test/usr/local/lib/libmyhello.la
/tmp/test/usr/local/lib/libmyhello.so
/tmp/test/usr/local/lib/libmyhello.so.0
/tmp/test/usr/local/lib/libmyhello.so.0.0.0
\end{minted}
\end{block}

\end{frame}

\begin{frame}{Libtool versioning}
  \begin{itemize}
  \item Needed to support changes in the library interface
  \item Each system handles library versioning differently
  \item \code{libtool} does not use the traditional
    \code{<major>.<minor>.<revision>}
  \item It uses a more abstract representation, converted differently
    depending on the system on which you're building.
  \item \code{libtool} representation is
    \code{<current>:<revision>:<age>}
    \begin{itemize}
    \item \code{current} is the interface number, incremented whenever
      the public interface changes
    \item \code{revision} is incremented whenever the library source
      code is changed
    \item \code{age} is incremented when new functions are added,
      reset to 0 when functions are removed
    \end{itemize}
  \item Defined using \code{-version-info <current>:<revision>:<age>}
    in \code{<product>_LDFLAGS}
  \end{itemize}
\end{frame}

\begin{frame}[fragile]{Libtool versioning: example}

\begin{block}{Makefile.am}
\begin{minted}{make}
lib_LTLIBRARIES = libmyhello.la
libmyhello_la_SOURCES = lib/core.c
libmyhello_la_LDFLAGS = -version-info 3:4:2
\end{minted}
\end{block}

\begin{block}{Installation}
\begin{minted}[fontsize=\tiny]{console}
$ make DESTDIR=/tmp/p install
[...]
$ ls -l /tmp/p/usr/local/lib
-rw-r--r-- 1 thomas thomas  6224 mai   20 15:28 libmyhello.a
-rwxr-xr-x 1 thomas thomas   963 mai   20 15:28 libmyhello.la
lrwxrwxrwx 1 thomas thomas    19 mai   20 15:28 libmyhello.so -> libmyhello.so.1.2.4
lrwxrwxrwx 1 thomas thomas    19 mai   20 15:28 libmyhello.so.1 -> libmyhello.so.1.2.4
-rwxr-xr-x 1 thomas thomas 10608 mai   20 15:28 libmyhello.so.1.2.4
\end{minted}
\end{block}

\end{frame}

\subsection{Misc}

\begin{frame}[fragile]{Global {\em automake} variables}

  \begin{itemize}
  \item Variables that you can define in \code{Makefile.am}
    \begin{itemize}
    \item Apply to the current \code{Makefile.am}
    \item Affect all products described in the current \code{Makefile.am}
    \end{itemize}
  \item \code{AM_CPPFLAGS}, default pre-processor flags
  \item \code{AM_CFLAGS}, default compiler flags
  \item \code{AM_LDFLAGS}, default linker flags
  \item \code{LDADD}, libraries not detected by {\em configure} that we
    should link with
  \item Do not set \code{CPPFLAGS}, \code{CFLAGS} and \code{LDFLAGS}, so
    that they can be passed in the environment by users
  \end{itemize}

\begin{block}{Example}
\begin{minted}[fontsize=\tiny]{make}
LDADD = $(top_builddir)/glib/libglib-2.0.la
AM_CPPFLAGS = $(gmodule_INCLUDES) $(GLIB_DEBUG_FLAGS)
AM_CFLAGS = -g
\end{minted}
\end{block}

\end{frame}

\begin{frame}[fragile]{Per product variables}
  \begin{itemize}
  \item \code{<product>_SOURCES}, list of source files
  \item \code{<product>_LDADD}, libraries to link with
  \item \code{<product>_CPPFLAGS}, pre-processor flags, overrides \code{AM_CPPFLAGS}
  \item \code{<product>_CFLAGS}, compiler flags, overrides \code{AM_CFLAGS}
  \item \code{<product>_LDFLAGS}, linker flags, overrides \code{AM_LDFLAGS}
  \end{itemize}

  \begin{block}{Example}
\begin{minted}[fontsize=\tiny]{make}
LDADD = $(top_builddir)/glib/libglib-2.0.la

module_test_LDADD = $(top_builddir)/gmodule/libgmodule-2.0.la $(LDADD)
module_test_LDFLAGS = $(G_MODULE_LDFLAGS)
slice_threadinit_LDADD = $(top_builddir)/gthread/libgthread-2.0.la $(LDADD)
\end{minted}
  \end{block}
\end{frame}

\begin{frame}[fragile]{Useful variables}

  \begin{itemize}

  \item Autoconf provides several variables that can be useful in your
    \code{Makefile.am}:

    \begin{itemize}

    \item \code{top_srcdir}, the relative path to the top of the source tree
    \item \code{srcdir}, the relative path to the directory that contains the current \code{Makefile}
    \item \code{top_builddir}, the relative path to the top of the build tree
    \item \code{builddir}, the current directory
    \item \code{abs_top_srcdir}, \code{abs_srcdir},
      \code{abs_top_builddir}, \code{abs_builddir}, absolute variants
      of the previous variables
    \end{itemize}

  \item Example usage: library code in \code{lib/}, header files in
    \code{include/}:
    \begin{block}{lib/Makefile.am}
    \begin{minted}[fontsize=\scriptsize]{make}
lib_LTLIBRARIES = libhello.la
libhello_la_SOURCES = ...
libhello_la_CPPFLAGS = -I$(top_srcdir)/include
\end{minted}
\end{block}

  \end{itemize}

\end{frame}

\begin{frame}[fragile]{Silent rules}

  \begin{itemize}
  \item By default, {\em automake} generate Makefiles that displays
    the full compilation commands
  \item Using the \code{AM_SILENT_RULES}, you can get a slimmer build
    output
  \item By default, the output remains verbose, but can be silenced by
    passing the \code{V=0} variable.
  \item If \code{AM_SILENT_RULES([yes])} is used, the output is quiet
    by default, and verbose if \code{V=1} is passed.
  \end{itemize}

  \begin{block}{}
\begin{minted}[fontsize=\tiny]{console}
$ make
  CC       lib/core.lo
  CCLD     libmyhello.la
  CC       src/main.o
  CCLD     hello
$ make V=1
[...]
libtool: link: (cd ".libs" && rm -f "libmyhello.so.0" && ln -s "libmyhello.so.0.0.0" ...
libtool: link: (cd ".libs" && rm -f "libmyhello.so" && ln -s "libmyhello.so.0.0.0" ...
libtool: link: ar cru .libs/libmyhello.a  lib/core.o
libtool: link: ranlib .libs/libmyhello.a
[...]
\end{minted}
  \end{block}

\end{frame}

\begin{frame}[fragile]{make dist}

  \begin{itemize}
  \item \code{make dist} generates a tarball to release the software
  \item All files listed in \code{_SOURCES} variables are
    automatically included, as well as the necessary {\em autotools}
    files
  \item Additional files can be added to the distribution using the
    \code{EXTRA_DIST} variable in \code{Makefile.am}:
\begin{block}{Makefile.am}
\begin{minted}[fontsize=\tiny]{make}
# These files are used in the preparation of a release
EXTRA_DIST += \
  PrepareRelease \
  CheckMan \
  CleanTxt \
  [...]
\end{minted}
\end{block}
\item Distribution can also be controlled using the \code{dist} and
  \code{nodist} {\em automake} product modifiers:
\begin{block}{Makefile.am}
\begin{minted}[fontsize=\tiny]{make}
nodist_include_HEADERS += pcrecpparg.h
dist_doc_DATA = doc/pcre.txt
\end{minted}
\end{block}

\end{itemize}

\end{frame}

\begin{frame}[fragile]{Macro directory}

  \begin{itemize}

  \item By default, all the third-party {\em autoconf} macros get
    copied into the (very large) \code{aclocal.m4} file.

  \item It is possible to get some of the third-party macros copied to
    individiual files in a separate directory, which is nicer.

  \item Directory declared using \code{AC_CONFIG_MACRO_DIR}, generally
    named \code{m4} by convention:
    \begin{block}{configure.ac}
      \begin{minted}{bash}
AC_CONFIG_MACRO_DIR([m4])
\end{minted}
\end{block}

\item The \code{ACLOCAL_AMFLAGS} in \code{Makefile.am} should also be
  adjusted:

\begin{block}{Makefile.am}
  \begin{minted}{make}
ACLOCAL_AMFLAGS = -I m4
\end{minted}
\end{block}

\item For now, mainly used by \code{libtool} for its own {\em m4}
  macros.

  \end{itemize}

\end{frame}

\begin{frame}[fragile]{Auxiliary directory}

  \begin{itemize}

  \item The {\em auxiliary files} generated by {\em autotools} such as
    \code{compile}, \code{config.guess}, \code{config.sub},
    \code{depcomp}, etc. are by default in the main directory of the
    source tree.

  \item This clutters the main directory with lots of files, which may
    not be very pleasant.

  \item \code{AC_CONFIG_AUX_DIR} allows to customize where these files
    are generated:
    \begin{block}{configure.ac}
      \begin{minted}{bash}
AC_CONFIG_AUX_DIR([build-aux])
\end{minted}
\end{block}

\item One condition: it must be placed before the calls to
  \code{AM_INIT_AUTOMAKE} and \code{LT_INIT}

  \end{itemize}

\end{frame}

\setuplabframe
{More advanced {\em autotools} usage}
{
  \begin{itemize}
  \item Use {\tt AC\_ARG\_ENABLE} and {\tt config.h}
  \item Implement a shared library
  \item Switch to multiple directories
  \item Make the compilation of programs conditional
  \item Use {\tt pkg-config}
  \end{itemize}
}
